<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>BPNP Map (Demo)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="img/favicon.ico" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="map" style="width: 100%; height: 100vh;"></div>

  <!-- ช่องค้นหาเลขแปลง -->
  <div id="search-container">
    <input id="searchBox" list="parcelList" placeholder="ค้นหาเลขแปลง..." />
    <datalist id="parcelList"></datalist>
  </div>

  <div id="legendContainer"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>
  <script src="https://unpkg.com/leaflet-control-layers-expanded/leaflet-control-layers-expanded.min.js"></script>
  <script src="setLegend.js"></script>
  <script>
    const map = L.map("map").setView([15.0, 100.0], 6);

    // แผนที่พื้นฐาน
    const baseMap = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    // กลุ่มชั้นข้อมูล
    const layerPolygonLand = L.layerGroup();
    const overlays = {
      "ผังการเวนคืนที่ดิน (Legend)": layerPolygonLand
    };

    L.control.layers(null, overlays, { collapsed: false }).addTo(map);

    // ===========================
    // โหลด polygon.kml เพียงครั้งเดียว
    // ===========================
    const parcelFeatures = []; // เก็บข้อมูลสำหรับค้นหา

    function loadPolygonLand() {
      omnivore.kml("polygon.kml")
        .on("ready", function () {
          this.eachLayer(function (layer) {
            const props = layer.feature.properties;

            // เก็บไว้ค้นหา
            parcelFeatures.push({ code: props.Code, layer });

            // bindPopup
            const popupContent = `
              <div class="custom-popup">
                <b>เลขแปลง:</b> ${props.Code}<br>
                <b>สถานะ:</b> ${props.Status}
              </div>
            `;
            layer.bindPopup(popupContent);
          });

          // เติม datalist
          const parcelList = document.getElementById("parcelList");
          parcelFeatures.forEach((f) => {
            const option = document.createElement("option");
            option.value = f.code;
            parcelList.appendChild(option);
          });

          layerPolygonLand.addLayer(this);
        })
        .on("error", function (e) {
          console.error("เกิดข้อผิดพลาดในการโหลด polygon.kml", e.error);
        });
    }

    loadPolygonLand();

    // ===========================
    // ค้นหาเลขแปลง
    // ===========================
    document.getElementById("searchBox").addEventListener("change", function () {
      const inputCode = this.value.trim();
      const match = parcelFeatures.find((f) => f.code === inputCode);

      if (match) {
        const center = match.layer.getBounds().getCenter();
        map.setView(center, 15);
        match.layer.openPopup();
      } else {
        alert("ไม่พบเลขแปลงนี้ในระบบ");
      }
    });
  </script>
</body>
</html>
